<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Pelajaran & Sosial Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animation for day transition - simplified for stability */
        .day-schedule {
            transition: opacity 0.4s ease-in-out; /* Only fade for simplicity */
        }
        .day-schedule.hidden {
            opacity: 0;
            position: absolute; /* Keep absolute for consistent layout during transition */
            top: 0;
            left: 0;
            right: 0;
            pointer-events: none;
        }
        /* No more slide classes needed with simplified transition */

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none; /* Hidden by default */
        }
        .sidebar-overlay.active {
            display: block;
        }

        /* Sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-out;
            transform: translateX(-100%); /* Hidden by default on mobile */
        }
        #sidebar.active {
            transform: translateX(0); /* Shown on mobile */
        }

        /* Main content area on larger screens */
        @media (min-width: 768px) { /* md breakpoint */
            #sidebar {
                transform: translateX(0); /* Always visible on desktop */
            }
        }

        /* Kebab menu for photo deletion */
        .kebab-menu {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 9999px; /* Full rounded */
            padding: 4px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
        }

        .group:hover .kebab-menu {
            opacity: 1;
        }

        .kebab-menu-dropdown {
            position: absolute;
            top: 100%; /* Position below the kebab menu button */
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            min-width: 120px;
            overflow: hidden;
        }

        .kebab-menu-dropdown button {
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
            color: #ef4444; /* red-500 */
            transition: background-color 0.2s ease-in-out;
        }

        .kebab-menu-dropdown button:hover {
            background-color: #fef2f2; /* red-50 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Mobile Header (Visible only on small screens) -->
    <header class="md:hidden flex items-center justify-between p-4 bg-blue-600 dark:bg-blue-700 text-white shadow-md">
        <button id="hamburger-menu" class="p-2 rounded-md hover:bg-blue-500">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        <h1 class="text-xl font-bold">Aplikasi Sekolah</h1>
        <div class="w-6"></div> <!-- Placeholder for alignment -->
    </header>

    <!-- Main Application Container -->
    <div class="flex flex-grow">
        <!-- Sidebar Overlay (for mobile) -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- Sidebar -->
        <nav id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-gray-800 dark:bg-gray-900 text-white p-4 z-40 md:relative md:translate-x-0 md:flex-shrink-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Menu</h2>
                <button id="close-sidebar" class="md:hidden p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <ul class="space-y-2">
                <li>
                    <a href="#" id="nav-jadwal" class="flex items-center p-3 rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        Jadwal Pelajaran
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-pr" class="flex items-center p-3 rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 .75.75 0 000 1.5c-.836 0-1.5.664-1.5 1.5h-.001a.75.75 0 00-1.5 0v.001A2 2 0 014 5zm-1 7a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zm1-4a1 1 0 000 2h6a1 1 0 100-2H4z" clip-rule="evenodd" /></svg>
                        Daftar PR
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-history-pr" class="flex items-center p-3 rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>
                        Riwayat PR
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-profile" class="flex items-center p-3 rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        Profil Saya
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-find-users" class="flex items-center p-3 rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17.555 17.445a1 1 0 01-1.414 1.414l-2.5-2.5a1 1 0 010-1.414l2.5-2.5a1 1 0 011.414 1.414L16.414 15l1.141 1.141z" /><path fill-rule="evenodd" d="M10 12a4 4 0 100-8 4 4 0 000 8zm-7 8a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        Cari Pengguna
                    </a>
                </li>
            </ul>
            <div class="absolute bottom-4 left-4 right-4">
                <div class="flex items-center justify-between text-sm text-gray-300 mb-2">
                    <p id="user-id-display" class="truncate">Belum login</p>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm hidden transition-transform transform hover:scale-105">Logout</button>
                </div>
                <button id="auth-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Login / Register</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <div class="w-full max-w-4xl mx-auto">

                <!-- Jadwal Pelajaran Section -->
                <section id="jadwal-section" class="content-section">
                    <h1 class="text-3xl font-bold text-center mb-4 md:mb-6">Jadwal Pelajaran</h1>
                    <div class="flex justify-center items-center mb-4">
                        <label for="class-select" class="mr-2 text-gray-700 dark:text-gray-300">Pilih Kelas:</label>
                        <select id="class-select" class="px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <p id="current-class-display" class="text-center text-blue-600 dark:text-blue-400 font-semibold mb-6">Kelas: 12-1 (A1)</p>
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-day" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 id="current-day-title" class="text-xl font-semibold"></h2>
                        <button id="next-day" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                    <div id="schedule-container" class="relative overflow-hidden" style="min-height: 200px;">
                        <!-- Schedules will be injected here by JS -->
                    </div>
                </section>

                <!-- Daftar PR Section -->
                <section id="pr-section" class="content-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-3xl font-bold">Daftar PR</h3>
                        <button id="add-pr-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 hidden">
                            Tambah PR
                        </button>
                    </div>
                    <div id="pr-list" class="space-y-4 pr-2 custom-scrollbar">
                        <p id="no-pr-message" class="text-gray-500 dark:text-gray-400 text-center mt-8 hidden">Belum ada PR. Selamat! 🎉</p>
                        <div id="loading-pr" class="flex justify-center items-center py-4 hidden">
                            <div class="spinner"></div>
                            <span class="ml-2 text-gray-500 dark:text-gray-400">Memuat PR...</span>
                        </div>
                        <p id="login-prompt-message" class="text-gray-500 dark:text-gray-400 text-center mt-8 hidden">Login untuk melihat dan menambahkan PR Anda.</p>
                    </div>
                </section>

                <!-- Riwayat PR Section -->
                <section id="history-pr-section" class="content-section hidden">
                    <h3 class="text-3xl font-bold mb-6">Riwayat PR Selesai</h3>
                    <div id="history-pr-list" class="space-y-4 pr-2 custom-scrollbar">
                        <p id="no-history-pr-message" class="text-gray-500 dark:text-gray-400 text-center mt-8 hidden">Belum ada PR yang diselesaikan.</p>
                        <div id="loading-history-pr" class="flex justify-center items-center py-4 hidden">
                            <div class="spinner"></div>
                            <span class="ml-2 text-gray-500 dark:text-gray-400">Memuat riwayat PR...</span>
                        </div>
                    </div>
                </section>

                <!-- Profil Saya Section -->
                <section id="profile-section" class="content-section hidden">
                    <h3 class="text-3xl font-bold mb-6">Profil Saya</h3>
                    <div id="profile-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6">
                        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
                            <div class="relative">
                                <img id="profile-avatar" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500 cursor-pointer" src="https://placehold.co/96x96/cccccc/333333?text=Avatar" alt="Profile Avatar">
                                <button id="edit-avatar-btn" class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 text-xs shadow-md hover:bg-blue-600 transition-transform transform hover:scale-110">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                            </div>
                            <div class="text-center md:text-left">
                                <input type="text" id="profile-name-input" class="text-2xl font-bold bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-blue-500 focus:outline-none mb-1 w-full text-center md:text-left" placeholder="Nama Pengguna">
                                <p id="profile-email" class="text-gray-600 dark:text-gray-400 text-sm">email@example.com</p>
                                <p id="profile-class" class="text-blue-600 dark:text-blue-400 font-semibold text-sm">Kelas: Belum Dipilih</p>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="profile-bio-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bio Anda:</label>
                            <textarea id="profile-bio-input" rows="3" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tulis sesuatu tentang diri Anda..."></textarea>
                        </div>
                        <button id="save-profile-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mb-6">
                            Simpan Profil
                        </button>

                        <div class="flex justify-around text-center mb-6">
                            <div>
                                <p class="text-2xl font-bold" id="follower-count">0</p>
                                <p class="text-gray-600 dark:text-gray-400">Follower</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="following-count">0</p>
                                <p class="text-gray-600 dark:text-gray-400">Following</p>
                            </div>
                        </div>

                        <h4 class="text-xl font-bold mb-4">Postingan Foto</h4>
                        <div id="profile-photos" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Photos will be injected here -->
                            <p id="no-photos-message" class="text-gray-500 dark:text-gray-400 col-span-full text-center hidden">Belum ada foto yang diunggah.</p>
                        </div>
                        <button id="upload-profile-photo-btn" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                            Upload Foto Baru
                        </button>
                        
                        <h4 class="text-xl font-bold mt-8 mb-4">PR Saya</h4>
                        <div id="profile-pr-list" class="space-y-3 custom-scrollbar max-h-60 overflow-y-auto">
                            <p id="no-profile-pr-message" class="text-gray-500 dark:text-gray-400 text-center mt-8 hidden">Belum ada PR yang aktif.</p>
                        </div>
                    </div>
                </section>

                <!-- Cari Pengguna Section -->
                <section id="find-users-section" class="content-section hidden">
                    <h3 class="text-3xl font-bold mb-6">Cari Pengguna</h3>
                    <div class="mb-4">
                        <input type="text" id="user-search-input" placeholder="Cari berdasarkan email atau nama..." class="w-full px-4 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="user-search-results" class="space-y-3">
                        <p id="no-search-results" class="text-gray-500 dark:text-gray-400 text-center hidden">Tidak ada pengguna ditemukan.</p>
                        <div id="loading-users" class="flex justify-center items-center py-4 hidden">
                            <div class="spinner"></div>
                            <span class="ml-2 text-gray-500 dark:text-gray-400">Mencari pengguna...</span>
                        </div>
                    </div>
                </section>

                <!-- View Other User Profile Modal -->
                <div id="other-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold" id="other-profile-modal-title">Profil Pengguna</h2>
                            <button id="close-other-profile-modal-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <div id="other-profile-content">
                            <div class="flex items-center space-x-4 mb-6">
                                <img id="other-profile-avatar" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500" src="https://placehold.co/96x96/cccccc/333333?text=Avatar" alt="Profile Avatar">
                                <div>
                                    <h4 id="other-profile-name" class="text-2xl font-bold"></h4>
                                    <p id="other-profile-email" class="text-gray-600 dark:text-gray-400"></p>
                                    <p id="other-profile-class" class="text-blue-600 dark:text-blue-400 font-semibold"></p>
                                </div>
                            </div>
                            <div class="flex justify-around text-center mb-6">
                                <div>
                                    <p class="text-2xl font-bold" id="other-follower-count">0</p>
                                    <p class="text-gray-600 dark:text-gray-400">Follower</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold" id="other-following-count">0</p>
                                    <p class="text-gray-600 dark:text-gray-400">Following</p>
                                </div>
                            </div>
                            <button id="follow-unfollow-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mb-6 hidden">
                                Follow
                            </button>

                            <h4 class="text-xl font-bold mb-4">Postingan Foto</h4>
                            <div id="other-profile-photos" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <p id="no-other-photos-message" class="text-gray-500 dark:text-gray-400 col-span-full text-center hidden">Pengguna ini belum mengunggah foto.</p>
                            </div>

                            <h4 class="text-xl font-bold mt-8 mb-4">PR Aktif</h4>
                            <div id="other-profile-pr-list" class="space-y-3 custom-scrollbar max-h-60 overflow-y-auto">
                                <p id="no-other-profile-pr-message" class="text-gray-500 dark:text-gray-400 text-center mt-8 hidden">Pengguna ini tidak memiliki PR aktif.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Detail Modal (for comments and likes) -->
                <div id="photo-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Detail Foto</h2>
                            <button id="close-photo-detail-modal-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <img id="detail-photo-img" src="" alt="Detail Photo" class="w-full h-auto object-contain rounded-lg mb-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <button id="like-btn" class="flex items-center text-blue-500 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3a1 1 0 01-1-1V9a1 1 0 011-1h1.586a1 1 0 00.707-.293l3.414-3.414A1 1 0 019.586 3H12a2 2 0 012 2v1h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3a1 1 0 01-1-1V9a1 1 0 011-1h1.586a1 1 0 00.707-.293l3.414-3.414A1 1 0 019.586 3H12a2 2 0 012 2v1z" /></svg>
                                <span id="like-count">0</span>
                            </button>
                            <span class="text-gray-500">|</span>
                            <span class="text-gray-600 dark:text-gray-400" id="comment-count">0 Komentar</span>
                        </div>
                        <div id="liked-by-list" class="mb-4 text-sm text-gray-700 dark:text-gray-300 hidden">
                            <p class="font-semibold mb-1">Disukai oleh:</p>
                            <ul id="liked-by-ul" class="list-disc list-inside pl-2"></ul>
                        </div>
                        <div id="comments-list" class="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scrollbar">
                            <!-- Comments will be injected here -->
                            <p id="no-comments-message" class="text-gray-500 dark:text-gray-400 hidden">Belum ada komentar.</p>
                        </div>
                        <form id="comment-form" class="flex space-x-2">
                            <input type="text" id="comment-input" placeholder="Tambahkan komentar..." class="flex-grow px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Kirim</button>
                        </form>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <!-- Modal for adding PR -->
    <div id="pr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Tambah PR Baru</h2>
            <form id="pr-form">
                <div class="mb-4">
                    <label for="pr-desc" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deskripsi PR</label>
                    <input type="text" id="pr-desc" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="pr-due-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deadline PR (Opsional)</label>
                    <input type="date" id="pr-due-date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700">
                </div>
                <div class="mb-6">
                    <label for="pr-file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Upload Foto atau Dokumen (Opsional)</label>
                    <input type="file" id="pr-file" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-pr-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Batal</button>
                    <button type="submit" id="save-pr-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Auth (Login/Register) -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="auth-modal-title" class="text-xl font-bold mb-4 text-center">Login</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="auth-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" id="auth-email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="auth-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="auth-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <p id="auth-error-message" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-auth-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Batal</button>
                    <button type="submit" id="auth-submit-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Login</button>
                </div>
            </form>
            <button id="toggle-auth-mode" class="w-full mt-4 text-sm text-blue-500 hover:underline">Belum punya akun? Register di sini.</button>
            <div class="mt-4 text-center">
                <div class="relative flex items-center justify-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-500 dark:text-gray-400">ATAU</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <button id="google-login-btn" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-transform transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12.0003 4.75C14.0263 4.75 15.8453 5.483 17.2023 6.757L20.0483 3.911C18.0673 2.097 15.2303 1 12.0003 1C7.79533 1 4.10933 3.447 2.36833 7.049L5.62633 9.516C6.44633 7.054 8.94833 4.75 12.0003 4.75Z" fill="#EA4335"/>
                        <path d="M23.0003 12.0003C23.0003 11.3463 22.9463 10.6933 22.8443 10.0533H12.0003V14.3913H18.3983C18.1183 15.6173 17.3473 16.6693 16.2043 17.3883L19.4623 19.8553C21.3193 18.1073 23.0003 15.0643 23.0003 12.0003Z" fill="#4285F4"/>
                        <path d="M5.62598 14.484C5.24498 13.339 5.03198 12.17 5.03198 11.0003C5.03198 9.83033 5.24498 8.66133 5.62598 7.51633L2.36898 5.04933C1.04198 7.73433 1.04198 10.2663 2.36898 12.9513L5.62598 14.484Z" fill="#FBBC05"/>
                        <path d="M12.0003 20.25C15.2303 20.25 18.0673 19.143 20.0483 17.329L17.2023 14.483C15.8453 15.757 14.0263 16.49 12.0003 16.49C8.94833 16.49 6.44633 14.186 5.62633 11.724L2.36833 14.191C4.10933 17.793 7.79533 20.25 12.0003 20.25Z" fill="#34A853"/>
                    </svg>
                    Login dengan Google
                </button>
            </div>
        </div>
    </div>

    <!-- New Modal for LLM Response -->
    <div id="llm-response-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" id="llm-modal-title">Bantuan PR ✨</h2>
                <button id="close-llm-modal-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="llm-response-content" class="text-gray-700 dark:text-gray-300 max-h-80 overflow-y-auto custom-scrollbar">
                <div id="llm-loading-spinner" class="flex justify-center items-center py-4 hidden">
                    <div class="spinner"></div>
                    <span class="ml-2 text-gray-500 dark:text-gray-400">Memuat penjelasan...</span>
                </div>
                <p id="llm-response-text"></p>
            </div>
        </div>
    </div>

    <!-- Class Selection Modal (shown after login if class not set) -->
    <div id="class-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Pilih Kelas Anda</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Pilih kelas default Anda untuk melihat jadwal dan PR yang relevan.</p>
            <select id="initial-class-select" class="w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 mb-6">
                <!-- Options will be populated by JS -->
            </select>
            <button id="save-class-selection-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Simpan Pilihan</button>
        </div>
    </div>

    <!-- Image Overlay for PR files -->
    <div id="image-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <img id="overlay-image" src="" alt="Full size image" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-lg">
    </div>

    <!-- New Modal for Photo Upload with Preview and Loading -->
    <div id="photo-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Unggah Foto Profil</h2>
            <div class="flex flex-col items-center mb-4">
                <img id="photo-upload-preview" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-300 dark:border-gray-600 mb-4 hidden" src="" alt="Pratinjau Foto">
                <input type="file" id="photo-upload-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600">
            </div>
            <p id="photo-upload-error" class="text-red-500 text-sm mb-4 hidden"></p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-photo-upload-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Batal</button>
                <button type="button" id="confirm-photo-upload-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center justify-center">
                    <span id="photo-upload-btn-text">Unggah</span>
                    <div id="photo-upload-spinner" class="spinner ml-2 hidden"></div>
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, query, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const currentFirebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Log the config being used for debugging
        console.log("App ID yang digunakan:", currentAppId);
        console.log("Firebase Config yang digunakan:", currentFirebaseConfig);

        // Explicitly use the user's provided config for testing, if it's different from __firebase_config
        const userProvidedFirebaseConfig = {
            apiKey: "AIzaSyCU1cQlzZ6AJI7UAfMsjEmb2mTe15KG9cQ",
            authDomain: "class-schedule-f7cea.firebaseapp.com",
            databaseURL: "https://class-schedule-f7cea-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "class-schedule-f7cea",
            storageBucket: "class-schedule-f7cea.firebasestorage.app",
            messagingSenderId: "192764707551",
            appId: "1:192764707551:web:051bb288069e895c4b1f6a",
            measurementId: "G-RF6ZMC9L7F"
        };
        
        // Prioritize __firebase_config if it's available and not empty, otherwise use the hardcoded one.
        const effectiveFirebaseConfig = Object.keys(currentFirebaseConfig).length > 0 ? currentFirebaseConfig : userProvidedFirebaseConfig;

        console.log("Effective Firebase Config (yang akan diinisialisasi):", effectiveFirebaseConfig);

        const app = initializeApp(effectiveFirebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider(); // Initialize Google Auth Provider

        let userId = null; // Will store the authenticated user ID
        let currentUserProfile = null; // Stores current user's profile data
        let homeworks = []; // Local array to hold active homework data
        let completedHomeworks = []; // Local array to hold completed homework data
        let unsubscribeHomeworks = null; // To store the unsubscribe function for active homeworks Firestore listener
        let unsubscribeCompletedHomeworks = null; // To store the unsubscribe function for completed homeworks Firestore listener
        let lastNotifiedScheduleItem = { dayIndex: -1, subjectIndex: -1 }; // To prevent duplicate class notifications

        // --- Schedule Data for Multiple Classes ---
        const allScheduleData = {
            '12-1 (A1)': {
                display: '12-1 (A1)',
                data: [
                    {
                        day: 'Senin',
                        subjects: [
                            { time: '07:45 - 09:15', name: 'Kimia', color: 'bg-red-200 dark:bg-red-800', textColor: 'text-red-800 dark:text-red-100' },
                            { time: '09:15 - 11:45', name: 'Matematika TL', color: 'bg-blue-200 dark:bg-blue-800', textColor: 'text-blue-800 dark:text-blue-100' },
                            { time: '11:45 - 13:15', name: 'Prakarya', color: 'bg-green-200 dark:bg-green-800', textColor: 'text-green-800 dark:text-green-100' },
                            { time: '13:55 - 15:15', name: 'Seni Budaya', color: 'bg-yellow-200 dark:bg-yellow-800', textColor: 'text-yellow-800 dark:text-yellow-100' }
                        ]
                    },
                    {
                        day: 'Selasa',
                        subjects: [
                            { time: '07:45 - 09:15', name: 'Fisika', color: 'bg-indigo-200 dark:bg-indigo-800', textColor: 'text-indigo-800 dark:text-indigo-100' },
                            { time: '09:15 - 11:00', name: 'Biologi', color: 'bg-teal-200 dark:bg-teal-800', textColor: 'text-teal-800 dark:text-teal-100' },
                            { time: '11:00 - 12:30', name: 'Bahasa Inggris', color: 'bg-pink-200 dark:bg-pink-800', textColor: 'text-pink-800 dark:text-pink-100' },
                            { time: '13:15 - 14:35', name: 'Matematika TL', color: 'bg-blue-200 dark:bg-blue-800', textColor: 'text-blue-800 dark:text-blue-100' }
                        ]
                    },
                    {
                        day: 'Rabu',
                        subjects: [
                            { time: '07:45 - 09:15', name: 'Biologi', color: 'bg-teal-200 dark:bg-teal-800', textColor: 'text-teal-800 dark:text-teal-100' },
                            { time: '09:15 - 11:45', name: 'Kimia', color: 'bg-red-200 dark:bg-red-800', textColor: 'text-red-800 dark:text-red-100' },
                            { time: '11:45 - 12:30', name: 'BK', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '13:15 - 14:35', name: 'PJOK', color: 'bg-orange-200 dark:bg-orange-800', textColor: 'text-orange-800 dark:text-orange-100' }
                        ]
                    },
                    {
                        day: 'Kamis',
                        subjects: [
                            { time: '07:45 - 09:15', name: 'Bahasa Indonesia', color: 'bg-purple-200 dark:bg-purple-800', textColor: 'text-purple-800 dark:text-purple-100' },
                            { time: '09:15 - 10:00', name: 'PPKn', color: 'bg-lime-200 dark:bg-lime-800', textColor: 'text-lime-800 dark:text-lime-100' },
                            { time: '10:15 - 11:45', name: 'MJ', color: 'bg-cyan-200 dark:bg-cyan-800', textColor: 'text-cyan-800 dark:text-cyan-100' },
                            { time: '11:45 - 13:15', name: 'Matematika', color: 'bg-sky-200 dark:bg-sky-800', textColor: 'text-sky-800 dark:text-sky-100' },
                            { time: '13:55 - 15:15', name: 'Sejarah', color: 'bg-amber-200 dark:bg-amber-800', textColor: 'text-amber-800 dark:text-amber-100' }
                        ]
                    },
                    {
                        day: 'Jumat',
                        subjects: [
                            { time: '07:00 - 08:30', name: 'Fisika', color: 'bg-indigo-200 dark:bg-indigo-800', textColor: 'text-indigo-800 dark:text-indigo-100' },
                            { time: '09:15 - 11:00', name: 'PAI', color: 'bg-emerald-200 dark:bg-emerald-800', textColor: 'text-emerald-800 dark:text-emerald-100' },
                            { time: '11:00 - 12:30', name: 'Bahasa Indonesia', color: 'bg-purple-200 dark:bg-purple-800', textColor: 'text-purple-800 dark:text-purple-100' },
                            { time: '13:15 - 14:35', name: 'Matematika', color: 'bg-sky-200 dark:bg-sky-800', textColor: 'text-sky-800 dark:text-sky-100' }
                        ]
                    }
                ]
            },
            '12-9 (D1)': {
                display: '12-9 (D1)',
                data: [
                    {
                        day: 'Senin',
                        subjects: [
                            { time: '07:00 - 07:45', name: 'Se', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '07:45 - 08:30', name: 'Eko', color: 'bg-green-200 dark:bg-green-800', textColor: 'text-green-800 dark:text-green-100' },
                            { time: '08:30 - 09:15', name: 'BigTL', color: 'bg-blue-200 dark:bg-blue-800', textColor: 'text-blue-800 dark:text-blue-100' },
                            { time: '09:15 - 10:00', name: 'Geo', color: 'bg-yellow-200 dark:bg-yellow-800', textColor: 'text-yellow-800 dark:text-yellow-100' },
                            { time: '10:15 - 11:00', name: 'PJO', color: 'bg-orange-200 dark:bg-orange-800', textColor: 'text-orange-800 dark:text-orange-100' },
                            { time: '11:00 - 11:45', name: 'Sos', color: 'bg-pink-200 dark:bg-pink-800', textColor: 'text-pink-800 dark:text-pink-100' },
                            { time: '11:45 - 12:30', name: 'MAT', color: 'bg-sky-200 dark:bg-sky-800', textColor: 'text-sky-800 dark:text-sky-100' },
                        ]
                    },
                    {
                        day: 'Selasa',
                        subjects: [
                            { time: '07:00 - 07:45', name: 'Se', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '07:45 - 08:30', name: 'Eko', color: 'bg-green-200 dark:bg-green-800', textColor: 'text-green-800 dark:text-green-100' },
                            { time: '08:30 - 09:15', name: 'BigTL', color: 'bg-blue-200 dark:bg-blue-800', textColor: 'text-blue-800 dark:text-blue-100' },
                            { time: '09:15 - 10:00', name: 'Bin', color: 'bg-purple-200 dark:bg-purple-800', textColor: 'text-purple-800 dark:text-purple-100' },
                            { time: '10:15 - 11:00', name: 'Sos', color: 'bg-pink-200 dark:bg-pink-800', textColor: 'text-pink-800 dark:text-pink-100' },
                            { time: '11:00 - 11:45', name: 'MAT', color: 'bg-sky-200 dark:bg-sky-800', textColor: 'text-sky-800 dark:text-sky-100' },
                            { time: '11:45 - 12:30', name: 'PJO', color: 'bg-orange-200 dark:bg-orange-800', textColor: 'text-orange-800 dark:text-orange-100' },
                        ]
                    },
                    {
                        day: 'Rabu',
                        subjects: [
                            { time: '07:00 - 07:45', name: 'Ra', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '07:45 - 08:30', name: 'PAI', color: 'bg-emerald-200 dark:bg-emerald-800', textColor: 'text-emerald-800 dark:text-emerald-100' },
                            { time: '08:30 - 09:15', name: 'Sos', color: 'bg-pink-200 dark:bg-pink-800', textColor: 'text-pink-800 dark:text-pink-100' },
                            { time: '09:15 - 10:00', name: 'Sjr', color: 'bg-amber-200 dark:bg-amber-800', textColor: 'text-amber-800 dark:text-amber-100' },
                            { time: '10:15 - 11:00', name: 'MJ', color: 'bg-cyan-200 dark:bg-cyan-800', textColor: 'text-cyan-800 dark:text-cyan-100' },
                        ]
                    },
                    {
                        day: 'Kamis',
                        subjects: [
                            { time: '07:00 - 07:45', name: 'Ka', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '07:45 - 08:30', name: 'Bin', color: 'bg-purple-200 dark:bg-purple-800', textColor: 'text-purple-800 dark:text-purple-100' },
                            { time: '08:30 - 09:15', name: 'Geo', color: 'bg-yellow-200 dark:bg-yellow-800', textColor: 'text-yellow-800 dark:text-yellow-100' },
                            { time: '09:15 - 10:00', name: 'BK', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '10:15 - 11:00', name: 'Eko', color: 'bg-green-200 dark:bg-green-800', textColor: 'text-green-800 dark:text-green-100' },
                            { time: '11:00 - 11:45', name: 'MAT', color: 'bg-sky-200 dark:bg-sky-800', textColor: 'text-sky-800 dark:text-sky-100' },
                        ]
                    },
                    {
                        day: 'Jumat',
                        subjects: [
                            { time: '07:00 - 07:45', name: 'Ju', color: 'bg-gray-200 dark:bg-gray-600', textColor: 'text-gray-800 dark:text-gray-100' },
                            { time: '07:45 - 08:30', name: 'PP', color: 'bg-lime-200 dark:bg-lime-800', textColor: 'text-lime-800 dark:text-lime-100' },
                            { time: '08:30 - 09:15', name: 'PK', color: 'bg-cyan-200 dark:bg-cyan-800', textColor: 'text-cyan-800 dark:text-cyan-100' },
                            { time: '09:15 - 10:00', name: 'SB', color: 'bg-yellow-200 dark:bg-yellow-800', textColor: 'text-yellow-800 dark:text-yellow-100' },
                            { time: '10:15 - 11:00', name: 'Big', color: 'bg-indigo-200 dark:bg-indigo-800', textColor: 'text-indigo-800 dark:text-indigo-100' },
                        ]
                    }
                ]
            }
        };

        let currentDayIndex = new Date().getDay() - 1; // 0 for Monday, 4 for Friday
        if (currentDayIndex < 0 || currentDayIndex > 4) {
            currentDayIndex = 0; // Default to Monday if it's weekend or invalid day
        }

        let currentScheduleData = allScheduleData['12-1 (A1)'].data; // Default schedule
        let currentClassName = '12-1 (A1)'; // Default class name

        document.addEventListener('DOMContentLoaded', async () => {
            const scheduleContainer = document.getElementById('schedule-container');
            const dayTitle = document.getElementById('current-day-title');
            const prevDayBtn = document.getElementById('prev-day');
            const nextDayBtn = document.getElementById('next-day');
            
            // PR elements
            const prList = document.getElementById('pr-list');
            const noPrMessage = document.getElementById('no-pr-message');
            const loadingPrMessage = document.getElementById('loading-pr');
            const loginPromptMessage = document.getElementById('login-prompt-message'); 
            const addPrBtn = document.getElementById('add-pr-btn');
            const prModal = document.getElementById('pr-modal');
            const prForm = document.getElementById('pr-form');
            const cancelPrBtn = document.getElementById('cancel-pr-btn');
            const savePrBtn = document.getElementById('save-pr-btn');
            const prDescInput = document.getElementById('pr-desc');
            const prDueDateInput = document.getElementById('pr-due-date'); 
            const prFileInput = document.getElementById('pr-file'); 
            const userIdDisplay = document.getElementById('user-id-display'); 
            const imageOverlay = document.getElementById('image-overlay');
            const overlayImage = document.getElementById('overlay-image');

            // Auth elements
            const authBtn = document.getElementById('auth-btn'); 
            const logoutBtn = document.getElementById('logout-btn'); 
            const authModal = document.getElementById('auth-modal'); 
            const authModalTitle = document.getElementById('auth-modal-title'); 
            const authForm = document.getElementById('auth-form'); 
            const authEmailInput = document.getElementById('auth-email'); 
            const authPasswordInput = document.getElementById('auth-password'); 
            const authSubmitBtn = document.getElementById('auth-submit-btn'); 
            const cancelAuthBtn = document.getElementById('cancel-auth-btn'); 
            const toggleAuthModeBtn = document.getElementById('toggle-auth-mode'); 
            const authErrorMessage = document.getElementById('auth-error-message'); 
            const googleLoginBtn = document.getElementById('google-login-btn'); 

            // LLM elements
            const llmResponseModal = document.getElementById('llm-response-modal');
            const closeLlmModalBtn = document.getElementById('close-llm-modal-btn');
            const llmResponseContent = document.getElementById('llm-response-content');
            const llmLoadingSpinner = document.getElementById('llm-loading-spinner');
            const llmResponseText = document.getElementById('llm-response-text');
            const llmModalTitle = document.getElementById('llm-modal-title');

            // Navigation elements
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const sidebar = document.getElementById('sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const navJadwal = document.getElementById('nav-jadwal');
            const navPr = document.getElementById('nav-pr');
            const navHistoryPr = document.getElementById('nav-history-pr'); // New nav item
            const navProfile = document.getElementById('nav-profile'); // New nav item
            const navFindUsers = document.getElementById('nav-find-users'); // New nav item

            const jadwalSection = document.getElementById('jadwal-section');
            const prSection = document.getElementById('pr-section');
            const historyPrSection = document.getElementById('history-pr-section'); // New section
            const historyPrList = document.getElementById('history-pr-list'); // New list
            const noHistoryPrMessage = document.getElementById('no-history-pr-message'); // New message
            const loadingHistoryPr = document.getElementById('loading-history-pr'); // New loading

            const profileSection = document.getElementById('profile-section'); // New section
            const profileAvatar = document.getElementById('profile-avatar');
            const profileNameInput = document.getElementById('profile-name-input'); // New input for name
            const profileBioInput = document.getElementById('profile-bio-input'); // New input for bio
            const saveProfileBtn = document.getElementById('save-profile-btn'); // New save button
            const editAvatarBtn = document.getElementById('edit-avatar-btn'); // New button for avatar upload
            const profileEmail = document.getElementById('profile-email');
            const profileClass = document.getElementById('profile-class');
            const followerCount = document.getElementById('follower-count');
            const followingCount = document.getElementById('following-count');
            const profilePhotos = document.getElementById('profile-photos');
            const noPhotosMessage = document.getElementById('no-photos-message');
            const uploadProfilePhotoBtn = document.getElementById('upload-profile-photo-btn');
            const profilePrList = document.getElementById('profile-pr-list');
            const noProfilePrMessage = document.getElementById('no-profile-pr-message');

            const findUsersSection = document.getElementById('find-users-section'); // New section
            const userSearchInput = document.getElementById('user-search-input');
            const userSearchResults = document.getElementById('user-search-results');
            const noSearchResults = document.getElementById('no-search-results');
            const loadingUsers = document.getElementById('loading-users');

            const otherProfileModal = document.getElementById('other-profile-modal'); // New modal
            const closeOtherProfileModalBtn = document.getElementById('close-other-profile-modal-btn');
            const otherProfileAvatar = document.getElementById('other-profile-avatar');
            const otherProfileName = document.getElementById('other-profile-name');
            const otherProfileEmail = document.getElementById('other-profile-email');
            const otherProfileClass = document.getElementById('other-profile-class');
            const otherFollowerCount = document.getElementById('other-follower-count');
            const otherFollowingCount = document.getElementById('other-following-count');
            const followUnfollowBtn = document.getElementById('follow-unfollow-btn');
            const otherProfilePhotos = document.getElementById('other-profile-photos');
            const noOtherPhotosMessage = document.getElementById('no-other-photos-message');
            const otherProfilePrList = document.getElementById('other-profile-pr-list');
            const noOtherProfilePrMessage = document.getElementById('no-other-profile-pr-message');

            const photoDetailModal = document.getElementById('photo-detail-modal'); // New modal for photo details, likes, comments
            const closePhotoDetailModalBtn = document.getElementById('close-photo-detail-modal-btn');
            const detailPhotoImg = document.getElementById('detail-photo-img');
            const likeBtn = document.getElementById('like-btn');
            const likeCount = document.getElementById('like-count');
            const commentCount = document.getElementById('comment-count');
            const commentsList = document.getElementById('comments-list');
            const noCommentsMessage = document.getElementById('no-comments-message');
            const commentForm = document.getElementById('comment-form');
            const commentInput = document.getElementById('comment-input');
            const likedByList = document.getElementById('liked-by-list'); // New element to show who liked
            const likedByUl = document.getElementById('liked-by-ul'); // UL for liked by users

            const classSelect = document.getElementById('class-select'); // For schedule section
            const currentClassDisplay = document.getElementById('current-class-display');
            const initialClassSelect = document.getElementById('initial-class-select'); // For class selection modal
            const classSelectionModal = document.getElementById('class-selection-modal');
            const saveClassSelectionBtn = document.getElementById('save-class-selection-btn');

            // Photo Upload Modal elements
            const photoUploadModal = document.getElementById('photo-upload-modal');
            const photoUploadPreview = document.getElementById('photo-upload-preview');
            const photoUploadInput = document.getElementById('photo-upload-input');
            const photoUploadError = document.getElementById('photo-upload-error');
            const cancelPhotoUploadBtn = document.getElementById('cancel-photo-upload-btn');
            const confirmPhotoUploadBtn = document.getElementById('confirm-photo-upload-btn');
            const photoUploadBtnText = document.getElementById('photo-upload-btn-text');
            const photoUploadSpinner = document.getElementById('photo-upload-spinner');


            let isLoginMode = true; // true for login, false for register
            let currentViewedPhotoId = null; // To store the ID of the photo being viewed in detail modal
            let currentViewedPhotoUserId = null; // To store the user ID of the photo being viewed

            // --- Schedule Class Selection Logic ---
            function populateClassSelects() {
                classSelect.innerHTML = '';
                initialClassSelect.innerHTML = '';
                for (const className in allScheduleData) {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = allScheduleData[className].display;
                    classSelect.appendChild(option);

                    const initialOption = option.cloneNode(true);
                    initialClassSelect.appendChild(initialOption);
                }
            }

            function updateScheduleDisplay(className) {
                currentClassName = className;
                currentScheduleData = allScheduleData[className].data;
                currentClassDisplay.textContent = `Kelas: ${className}`;
                renderSchedules();
                // Set the selected option in the classSelect dropdown
                classSelect.value = className;
            }

            classSelect.addEventListener('change', (e) => {
                updateScheduleDisplay(e.target.value);
            });

            // --- Notification Functions ---
            async function requestNotificationPermission() {
                if (!("Notification" in window)) {
                    console.log("Browser ini tidak mendukung notifikasi desktop.");
                    return false;
                }
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    console.log("Izin notifikasi diberikan.");
                    return true;
                } else {
                    console.warn("Izin notifikasi ditolak.");
                    return false;
                }
            }

            function showNotification(title, body, iconUrl = 'https://placehold.co/48x48/000000/FFFFFF?text=🔔') {
                if (Notification.permission === "granted") {
                    new Notification(title, { body: body, icon: iconUrl });
                }
            }

            // --- Class Schedule Notification Logic ---
            function checkClassScheduleForNotifications() {
                const now = new Date();
                const currentDay = now.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                const todayScheduleIndex = currentDay === 0 || currentDay === 6 ? -1 : currentDay - 1;

                if (todayScheduleIndex === -1 || !currentScheduleData) {
                    return;
                }

                const todaySchedule = currentScheduleData[todayScheduleIndex];
                if (!todaySchedule) return;

                todaySchedule.subjects.forEach((subject, index) => {
                    const [startHour, startMinute] = subject.time.split(' - ')[0].split(':').map(Number);
                    
                    if (currentHour === startHour && currentMinute === startMinute && 
                        (lastNotifiedScheduleItem.dayIndex !== todayScheduleIndex || lastNotifiedScheduleItem.subjectIndex !== index)) {
                        
                        showNotification(`⏰ Jam Pelajaran Baru!`, `Sekarang waktunya ${subject.name}!`);
                        lastNotifiedScheduleItem = { dayIndex: todayScheduleIndex, subjectIndex: index };
                        console.log(`Notifikasi: Jam pelajaran ${subject.name} dimulai.`);
                    }
                });
            }

            // --- Homework Deadline Notification Logic ---
            function checkHomeworkDeadlines() {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to start of day for comparison

                homeworks.forEach(pr => {
                    if (pr.dueDate) {
                        const dueDate = new Date(pr.dueDate);
                        dueDate.setHours(0, 0, 0, 0); // Reset time to start of day for comparison

                        const diffTime = dueDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        const notificationKey = `notified_pr_${pr.id}_${pr.dueDate}`;

                        if (diffDays === 1 && !localStorage.getItem(notificationKey)) {
                            showNotification(`⚠️ Deadline PR Besok!`, `PR: "${pr.description}" deadlinenya besok!`);
                            localStorage.setItem(notificationKey, 'true'); 
                            console.log(`Notifikasi: Deadline PR "${pr.description}" besok.`);
                        }
                        if (diffDays <= 0 || diffDays > 1) {
                            localStorage.removeItem(notificationKey);
                        }
                    }
                });
            }


            // Function to handle file clicks (view image or download document)
            window.handleFileClick = (dataUrl, fileType, fileName) => {
                if (fileType && fileType.startsWith('image/')) {
                    // Ensure elements exist before using them
                    if (overlayImage && imageOverlay) {
                        overlayImage.src = dataUrl;
                        imageOverlay.classList.remove('hidden');
                    } else {
                        console.error("Overlay elements not found for image display.");
                    }
                } else {
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = fileName || 'document';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            };

            // Add null check before attaching event listener
            if (imageOverlay) {
                imageOverlay.addEventListener('click', () => {
                    imageOverlay.classList.add('hidden');
                });
            } else {
                console.error("Element with ID 'image-overlay' not found. Cannot attach click listener.");
            }

            // Firebase Authentication and Data Loading
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase authenticated. User ID:", userId);
                    await fetchUserProfile(userId); // Fetch current user's profile
                    
                    // If user's class is not set, show class selection modal
                    if (!currentUserProfile || !currentUserProfile.className) {
                        classSelectionModal.classList.remove('hidden');
                    } else {
                        updateScheduleDisplay(currentUserProfile.className);
                    }

                    userIdDisplay.textContent = `User ID: ${user.email || user.uid}`;
                    authBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    addPrBtn.classList.remove('hidden');
                    loginPromptMessage.classList.add('hidden');
                    listenForHomeworks(); // Start listening for active homeworks
                    listenForCompletedHomeworks(); // Start listening for completed homeworks
                } else {
                    userId = null;
                    currentUserProfile = null;
                    userIdDisplay.textContent = 'Belum login';
                    authBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    addPrBtn.classList.add('hidden');
                    loginPromptMessage.classList.remove('hidden');
                    prList.innerHTML = ''; 
                    noPrMessage.classList.remove('hidden'); 
                    loadingPrMessage.classList.add('hidden'); 
                    historyPrList.innerHTML = '';
                    noHistoryPrMessage.classList.remove('hidden');
                    loadingHistoryPr.classList.add('hidden');
                    if (unsubscribeHomeworks) {
                        unsubscribeHomeworks(); 
                    }
                    if (unsubscribeCompletedHomeworks) {
                        unsubscribeCompletedHomeworks();
                    }
                    console.log("User logged out or not authenticated.");
                }
            });

            // --- User Profile Management ---
            async function fetchUserProfile(uid) {
                const userDocRef = doc(db, `artifacts/${currentAppId}/users/${uid}/profile/data`);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        currentUserProfile = docSnap.data();
                        console.log("User profile loaded:", currentUserProfile);
                    } else {
                        // Create a basic profile if it doesn't exist
                        currentUserProfile = {
                            email: auth.currentUser.email,
                            name: auth.currentUser.displayName || auth.currentUser.email.split('@')[0],
                            bio: '', // New field
                            avatarUrl: 'https://placehold.co/96x96/cccccc/333333?text=Avatar',
                            className: null, // User will select this
                            photos: [],
                            followers: [],
                            following: []
                        };
                        await setDoc(userDocRef, currentUserProfile);
                        console.log("New user profile created.");
                    }
                    updateProfileUI();
                } catch (error) {
                    console.error("Error fetching or creating user profile:", error);
                }
            }

            async function updateProfileUI() {
                if (currentUserProfile) {
                    profileAvatar.src = currentUserProfile.avatarUrl || 'https://placehold.co/96x96/cccccc/333333?text=Avatar';
                    profileNameInput.value = currentUserProfile.name || ''; // Set value for input
                    profileBioInput.value = currentUserProfile.bio || ''; // Set value for input
                    profileEmail.textContent = currentUserProfile.email || 'email@example.com';
                    profileClass.textContent = `Kelas: ${currentUserProfile.className || 'Belum Dipilih'}`;
                    followerCount.textContent = currentUserProfile.followers ? currentUserProfile.followers.length : 0;
                    followingCount.textContent = currentUserProfile.following ? currentUserProfile.following.length : 0;
                    renderProfilePhotos(profilePhotos, currentUserProfile.photos, true); // true for current user's photos
                    renderProfilePRs(profilePrList, homeworks, true); // true for current user's PRs
                }
            }

            async function updateRemoteUserProfile(data) {
                if (!userId) return;
                const userDocRef = doc(db, `artifacts/${currentAppId}/users/${userId}/profile/data`);
                try {
                    await updateDoc(userDocRef, data);
                    console.log("User profile updated remotely.");
                    // Re-fetch profile to ensure UI is consistent
                    await fetchUserProfile(userId);
                } catch (error) {
                    console.error("Error updating user profile:", error);
                }
            }

            // --- Homeworks (Active) ---
            function listenForHomeworks() {
                if (!userId) {
                    console.warn("User ID not available for listening to homeworks.");
                    return;
                }

                if (unsubscribeHomeworks) {
                    unsubscribeHomeworks();
                }

                loadingPrMessage.classList.remove('hidden'); 
                noPrMessage.classList.add('hidden'); 
                const homeworksCollectionRef = collection(db, `artifacts/${currentAppId}/users/${userId}/homeworks`);
                const q = query(homeworksCollectionRef, where("completed", "!=", true)); // Filter for active PRs
                
                unsubscribeHomeworks = onSnapshot(q, (snapshot) => {
                    homeworks = [];
                    snapshot.forEach(doc => {
                        homeworks.push({ id: doc.id, ...doc.data() });
                    });
                    homeworks.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    renderPRs();
                    loadingPrMessage.classList.add('hidden'); 
                    if (homeworks.length === 0) {
                        prList.appendChild(noPrMessage); // Ensure message is in the list
                        noPrMessage.classList.remove('hidden');
                    } else {
                        noPrMessage.classList.add('hidden');
                    }
                    checkHomeworkDeadlines(); 
                    updateProfileUI(); // Update profile PR list
                }, (error) => {
                    console.error("Error fetching active homeworks:", error);
                    loadingPrMessage.classList.add('hidden'); 
                });
            }

            // --- Homeworks (Completed) ---
            function listenForCompletedHomeworks() {
                if (!userId) {
                    console.warn("User ID not available for listening to completed homeworks.");
                    return;
                }

                if (unsubscribeCompletedHomeworks) {
                    unsubscribeCompletedHomeworks();
                }

                loadingHistoryPr.classList.remove('hidden');
                noHistoryPrMessage.classList.add('hidden');
                const completedHomeworksCollectionRef = collection(db, `artifacts/${currentAppId}/users/${userId}/homeworks`);
                const q = query(completedHomeworksCollectionRef, where("completed", "==", true)); // Filter for completed PRs

                unsubscribeCompletedHomeworks = onSnapshot(q, (snapshot) => {
                    completedHomeworks = [];
                    snapshot.forEach(doc => {
                        completedHomeworks.push({ id: doc.id, ...doc.data() });
                    });
                    completedHomeworks.sort((a, b) => (b.completedTimestamp || 0) - (a.completedTimestamp || 0)); // Sort by completion time
                    renderHistoryPRs();
                    loadingHistoryPr.classList.add('hidden');
                    if (completedHomeworks.length === 0) {
                        historyPrList.appendChild(noHistoryPrMessage);
                        noHistoryPrMessage.classList.remove('hidden');
                    } else {
                        noHistoryPrMessage.classList.add('hidden');
                    }
                }, (error) => {
                    console.error("Error fetching completed homeworks:", error);
                    loadingHistoryPr.classList.add('hidden');
                });
            }

            // --- Render Functions ---
            function renderSchedules() {
                // Remove all existing schedule divs before re-rendering
                scheduleContainer.innerHTML = '';

                const day = currentScheduleData[currentDayIndex];
                const dayDiv = document.createElement('div');
                dayDiv.id = `day-${currentDayIndex}`;
                dayDiv.className = 'day-schedule w-full'; // No 'hidden' class initially

                const subjectsHtml = day.subjects.map(subject => `
                    <div class="flex items-center p-3 rounded-lg mb-2 ${subject.color} ${subject.textColor} shadow-sm">
                        <span class="font-medium w-28">${subject.time}</span>
                        <span class="font-semibold">${subject.name}</span>
                    </div>
                `).join('');

                dayDiv.innerHTML = `<div class="space-y-2">${subjectsHtml}</div>`;
                scheduleContainer.appendChild(dayDiv);
            }

            function updateDisplay() {
                dayTitle.textContent = currentScheduleData[currentDayIndex].day;
                renderSchedules(); // Re-render the current day's schedule
            }
            
            function showDay(index) {
                currentDayIndex = (index + currentScheduleData.length) % currentScheduleData.length;
                updateDisplay();
            }

            prevDayBtn.addEventListener('click', () => showDay(currentDayIndex - 1));
            nextDayBtn.addEventListener('click', () => showDay(currentDayIndex + 1));

            // Swipe functionality
            let touchStartX = 0;
            let touchEndX = 0;

            scheduleContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            scheduleContainer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                if (touchEndX < touchStartX - 50) { // Swiped left
                    showDay(currentDayIndex + 1);
                }
                if (touchEndX > touchStartX + 50) { // Swiped right
                    showDay(currentDayIndex - 1);
                }
            }


            function renderPRs() {
                prList.innerHTML = ''; 
                if (homeworks.length === 0) {
                    prList.appendChild(noPrMessage);
                    noPrMessage.classList.remove('hidden');
                } else {
                    noPrMessage.classList.add('hidden');
                    homeworks.forEach(pr => {
                        const prItem = document.createElement('div');
                        prItem.className = 'p-4 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3';
                        
                        let fileDisplayHtml = '';
                        if (pr.fileDataUrl) {
                            if (pr.fileType && pr.fileType.startsWith('image/')) {
                                fileDisplayHtml = `<img src="${pr.fileDataUrl}" alt="PR photo" class="w-20 h-20 sm:w-16 sm:h-16 rounded-md object-cover cursor-pointer flex-shrink-0" onclick="window.handleFileClick('${pr.fileDataUrl}', '${pr.fileType}', '${pr.fileName}')">`;
                            } else {
                                fileDisplayHtml = `
                                    <div class="flex items-center space-x-2 flex-shrink-0 cursor-pointer" onclick="window.handleFileClick('${pr.fileDataUrl}', '${pr.fileType}', '${pr.fileName}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-blue-500 hover:underline text-sm sm:text-base break-all">${pr.fileName || 'Dokumen'}</span>
                                    </div>
                                `;
                            }
                        }

                        let dueDateDisplay = '';
                        if (pr.dueDate) {
                            const date = new Date(pr.dueDate + 'T00:00:00'); // Ensure date is parsed correctly in local timezone
                            const options = { year: 'numeric', month: 'long', day: 'numeric' };
                            dueDateDisplay = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Deadline: ${date.toLocaleDateString('id-ID', options)}</p>`;
                        }

                        prItem.innerHTML = `
                            ${fileDisplayHtml}
                            <div class="flex-grow w-full"> 
                                <p class="font-medium text-base sm:text-lg">${pr.description}</p> 
                                ${dueDateDisplay}
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full mt-2">
                                    <button data-description="${pr.description}" class="explain-pr-btn px-3 py-1 bg-purple-500 text-white text-sm rounded-md hover:bg-purple-600 transition-transform transform hover:scale-105 w-full sm:w-auto">
                                        ✨ Jelaskan PR
                                    </button>
                                    <button data-description="${pr.description}" class="suggest-plan-btn px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-transform transform hover:scale-105 w-full sm:w-auto">
                                        ✨ Rencana Belajar
                                    </button>
                                </div>
                            </div>
                            <button data-id="${pr.id}" class="pr-done-btn flex-shrink-0 p-2 bg-green-500 text-white rounded-full hover:bg-green-600 self-end sm:self-center mt-2 sm:mt-0"> 
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                        `;
                        prList.appendChild(prItem);
                    });
                }
            }

            function renderHistoryPRs() {
                historyPrList.innerHTML = '';
                if (completedHomeworks.length === 0) {
                    historyPrList.appendChild(noHistoryPrMessage);
                    noHistoryPrMessage.classList.remove('hidden');
                } else {
                    noHistoryPrMessage.classList.add('hidden');
                    completedHomeworks.forEach(pr => {
                        const prItem = document.createElement('div');
                        prItem.className = 'p-4 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 opacity-70'; // Slightly faded
                        
                        let fileDisplayHtml = '';
                        if (pr.fileDataUrl) {
                            if (pr.fileType && pr.fileType.startsWith('image/')) {
                                fileDisplayHtml = `<img src="${pr.fileDataUrl}" alt="PR photo" class="w-20 h-20 sm:w-16 sm:h-16 rounded-md object-cover cursor-pointer flex-shrink-0" onclick="window.handleFileClick('${pr.fileDataUrl}', '${pr.fileType}', '${pr.fileName}')">`;
                            } else {
                                fileDisplayHtml = `
                                    <div class="flex items-center space-x-2 flex-shrink-0 cursor-pointer" onclick="window.handleFileClick('${pr.fileDataUrl}', '${pr.fileType}', '${pr.fileName}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-blue-500 hover:underline text-sm sm:text-base break-all">${pr.fileName || 'Dokumen'}</span>
                                    </div>
                                `;
                            }
                        }

                        let dueDateDisplay = '';
                        if (pr.dueDate) {
                            const date = new Date(pr.dueDate + 'T00:00:00');
                            const options = { year: 'numeric', month: 'long', day: 'numeric' };
                            dueDateDisplay = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Deadline: ${date.toLocaleDateString('id-ID', options)}</p>`;
                        }
                        let completedDateDisplay = '';
                        if (pr.completedTimestamp) {
                            const date = new Date(pr.completedTimestamp);
                            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                            completedDateDisplay = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Selesai pada: ${date.toLocaleDateString('id-ID', options)}</p>`;
                        }


                        prItem.innerHTML = `
                            ${fileDisplayHtml}
                            <div class="flex-grow w-full"> 
                                <p class="font-medium text-base sm:text-lg">${pr.description}</p> 
                                ${dueDateDisplay}
                                ${completedDateDisplay}
                            </div>
                            <button data-id="${pr.id}" class="pr-undo-btn flex-shrink-0 p-2 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 self-end sm:self-center mt-2 sm:mt-0"> 
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        `;
                        historyPrList.appendChild(prItem);
                    });
                }
            }

            function renderProfilePhotos(container, photosArray, isCurrentUser) {
                container.innerHTML = '';
                if (!photosArray || photosArray.length === 0) {
                    container.appendChild(isCurrentUser ? noPhotosMessage : noOtherPhotosMessage);
                    (isCurrentUser ? noPhotosMessage : noOtherPhotosMessage).classList.remove('hidden');
                } else {
                    (isCurrentUser ? noPhotosMessage : noOtherPhotosMessage).classList.add('hidden');
                    photosArray.forEach(photo => {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'relative w-full aspect-square rounded-lg overflow-hidden shadow-md cursor-pointer group'; // Added group for hover effects
                        imgDiv.innerHTML = `
                            <img src="${photo.url}" alt="User Photo" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-25 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <span class="text-white text-lg font-bold">${photo.likes.length} ❤️</span>
                            </div>
                            ${isCurrentUser ? `
                                <div class="kebab-menu relative">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                                    <div class="kebab-menu-dropdown hidden">
                                        <button data-photo-id="${photo.id}" class="delete-photo-btn">Hapus Postingan</button>
                                    </div>
                                </div>
                            ` : ''}
                        `;
                        // Event listener for the entire photo div to open detail modal
                        imgDiv.addEventListener('click', (e) => {
                            // Prevent opening detail modal if clicking on the kebab menu or its dropdown
                            if (!e.target.closest('.kebab-menu')) {
                                showPhotoDetail(photo, isCurrentUser);
                            }
                        });

                        // Event listener for the kebab menu button to toggle dropdown
                        if (isCurrentUser) {
                            const kebabMenu = imgDiv.querySelector('.kebab-menu');
                            const dropdown = imgDiv.querySelector('.kebab-menu-dropdown');
                            kebabMenu.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent click from bubbling to imgDiv and opening photo detail
                                dropdown.classList.toggle('hidden');
                            });

                            // Event listener for delete button inside dropdown
                            const deleteButton = imgDiv.querySelector('.delete-photo-btn');
                            deleteButton.addEventListener('click', async (e) => {
                                e.stopPropagation(); // Prevent click from bubbling up
                                dropdown.classList.add('hidden'); // Hide dropdown immediately
                                const photoIdToDelete = e.currentTarget.dataset.photoId;
                                if (confirm("Apakah Anda yakin ingin menghapus foto ini?")) {
                                    await deletePhoto(photoIdToDelete);
                                }
                            });
                        }
                        container.appendChild(imgDiv);
                    });
                }
            }

            async function deletePhoto(photoId) {
                if (!userId || !photoId) return;

                const userProfileDocRef = doc(db, `artifacts/${currentAppId}/users/${userId}/profile/data`);
                try {
                    const docSnap = await getDoc(userProfileDocRef);
                    if (docSnap.exists()) {
                        const profileData = docSnap.data();
                        const updatedPhotos = (profileData.photos || []).filter(photo => photo.id !== photoId);
                        await updateDoc(userProfileDocRef, { photos: updatedPhotos });
                        console.log(`Photo ${photoId} deleted successfully.`);
                        await fetchUserProfile(userId); // Re-fetch to update UI
                    }
                } catch (error) {
                    console.error("Error deleting photo:", error);
                }
            }

            function renderProfilePRs(container, prsArray, isCurrentUser) {
                container.innerHTML = '';
                const activePrs = prsArray.filter(pr => !pr.completed);
                if (activePrs.length === 0) {
                    container.appendChild(isCurrentUser ? noProfilePrMessage : noOtherProfilePrMessage);
                    (isCurrentUser ? noProfilePrMessage : noOtherProfilePrMessage).classList.remove('hidden');
                } else {
                    (isCurrentUser ? noProfilePrMessage : noOtherProfilePrMessage).classList.add('hidden');
                    activePrs.forEach(pr => {
                        const prItem = document.createElement('div');
                        prItem.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-start space-x-3';
                        let dueDateDisplay = '';
                        if (pr.dueDate) {
                            const date = new Date(pr.dueDate + 'T00:00:00');
                            const options = { year: 'numeric', month: 'long', day: 'numeric' };
                            dueDateDisplay = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Deadline: ${date.toLocaleDateString('id-ID', options)}</p>`;
                        }
                        prItem.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-medium text-sm">${pr.description}</p>
                                ${dueDateDisplay}
                            </div>
                        `;
                        container.appendChild(prItem);
                    });
                }
            }


            // --- Core Functionality Event Listeners ---
            addPrBtn.addEventListener('click', () => {
                if (!userId) {
                    console.warn("User not logged in. Cannot add PR.");
                    loginPromptMessage.classList.remove('hidden');
                    return;
                }
                prModal.classList.remove('hidden');
                prForm.reset(); 
                prDueDateInput.value = ''; // Clear date input
            });

            cancelPrBtn.addEventListener('click', () => {
                prModal.classList.add('hidden');
                prForm.reset();
            });

            prForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) {
                    console.error("User not logged in. Cannot save PR.");
                    return;
                }

                savePrBtn.disabled = true; 
                savePrBtn.innerHTML = '<div class="spinner"></div>'; 

                const description = prDescInput.value;
                const dueDate = prDueDateInput.value; 
                const uploadedFile = prFileInput.files[0]; 
                let fileDataUrl = null;
                let fileType = null;
                let fileName = null;

                if (uploadedFile) {
                    fileType = uploadedFile.type;
                    fileName = uploadedFile.name;
                    try {
                        fileDataUrl = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (event) => resolve(event.target.result);
                            reader.onerror = (error) => reject(error);
                            reader.readAsDataURL(uploadedFile);
                        });
                    } catch (error) {
                        console.error("Error reading file:", error);
                        savePrBtn.disabled = false;
                        savePrBtn.innerHTML = 'Simpan';
                        return; 
                    }
                }

                try {
                    await addDoc(collection(db, `artifacts/${currentAppId}/users/${userId}/homeworks`), {
                        description: description,
                        dueDate: dueDate, 
                        fileDataUrl: fileDataUrl, 
                        fileType: fileType,       
                        fileName: fileName,       
                        timestamp: Date.now(),
                        completed: false // Mark as not completed initially
                    });
                    console.log("PR added to Firestore successfully!");
                } catch (error) {
                    console.error("Error adding PR to Firestore:", error);
                }

                prModal.classList.add('hidden');
                prForm.reset();
                savePrBtn.disabled = false; 
                savePrBtn.innerHTML = 'Simpan'; 
            });

            prList.addEventListener('click', async (e) => {
                if (e.target.closest('.pr-done-btn')) {
                    const btn = e.target.closest('.pr-done-btn');
                    const prId = btn.dataset.id; 

                    if (userId && prId) {
                        try {
                            // Update PR to completed
                            await updateDoc(doc(db, `artifacts/${currentAppId}/users/${userId}/homeworks`, prId), {
                                completed: true,
                                completedTimestamp: Date.now()
                            });
                            console.log("PR marked as completed!");
                        } catch (error) {
                            console.error("Error marking PR as completed:", error);
                        }
                    } else {
                        console.error("User ID or PR ID not available. Cannot mark PR as completed.");
                    }
                } else if (e.target.closest('.explain-pr-btn')) {
                    const btn = e.target.closest('.explain-pr-btn');
                    const description = btn.dataset.description;
                    if (description) {
                        llmModalTitle.textContent = "Bantuan PR ✨"; 
                        explainHomework(description);
                    }
                } else if (e.target.closest('.suggest-plan-btn')) {
                    const btn = e.target.closest('.suggest-plan-btn');
                    const description = btn.dataset.description;
                    if (description) {
                        llmModalTitle.textContent = "Rencana Belajar ✨"; 
                        suggestStudyPlan(description);
                    }
                }
            });

            historyPrList.addEventListener('click', async (e) => {
                if (e.target.closest('.pr-undo-btn')) {
                    const btn = e.target.closest('.pr-undo-btn');
                    const prId = btn.dataset.id; 

                    if (userId && prId) {
                        try {
                            // Update PR to uncompleted
                            await updateDoc(doc(db, `artifacts/${currentAppId}/users/${userId}/homeworks`, prId), {
                                completed: false,
                                completedTimestamp: null // Clear completion timestamp
                            });
                            console.log("PR marked as uncompleted!");
                        } catch (error) {
                            console.error("Error marking PR as uncompleted:", error);
                        }
                    } else {
                        console.error("User ID or PR ID not available. Cannot mark PR as uncompleted.");
                    }
                }
            });
            
            // --- Authentication Modal Logic ---
            authBtn.addEventListener('click', () => {
                authModal.classList.remove('hidden');
                authErrorMessage.classList.add('hidden');
                authForm.reset();
                setAuthMode(true); 
            });

            cancelAuthBtn.addEventListener('click', () => {
                authModal.classList.add('hidden');
                authErrorMessage.classList.add('hidden');
                authForm.reset();
            });

            toggleAuthModeBtn.addEventListener('click', () => {
                setAuthMode(!isLoginMode);
            });

            function setAuthMode(mode) {
                isLoginMode = mode;
                if (isLoginMode) {
                    authModalTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Belum punya akun? Register di sini.';
                } else {
                    authModalTitle.textContent = 'Register';
                    authSubmitBtn.textContent = 'Register';
                    toggleAuthModeBtn.textContent = 'Sudah punya akun? Login di sini.';
                }
                authErrorMessage.classList.add('hidden'); 
            }

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authErrorMessage.classList.add('hidden'); 

                const email = authEmailInput.value;
                const password = authPasswordInput.value;

                if (!email || !password) {
                    authErrorMessage.textContent = "Email dan password harus diisi.";
                    authErrorMessage.classList.remove('hidden');
                    return;
                }
                if (password.length < 6) {
                    authErrorMessage.textContent = "Password minimal 6 karakter.";
                    authErrorMessage.classList.remove('hidden');
                    return;
                }

                authSubmitBtn.disabled = true;
                authSubmitBtn.innerHTML = '<div class="spinner"></div>';

                if (isLoginMode) {
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        authModal.classList.add('hidden');
                        authForm.reset();
                        console.log("User logged in successfully!");
                    } catch (error) {
                        let errorMessage = "Terjadi kesalahan saat login.";
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            errorMessage = "Email atau password salah.";
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = "Format email tidak valid.";
                        } else {
                             errorMessage = `Error: ${error.message}`; 
                        }
                        authErrorMessage.textContent = errorMessage;
                        authErrorMessage.classList.remove('hidden');
                        console.error("Login error:", error.message);
                    }
                } else {
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        authModal.classList.add('hidden');
                        authForm.reset();
                        console.log("User registered successfully!");
                    } catch (error) {
                        let errorMessage = "Terjadi kesalahan saat registrasi.";
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = "Email ini sudah terdaftar.";
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = "Password terlalu lemah (minimal 6 karakter).";
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = "Format email tidak valid.";
                        } else if (error.code === 'auth/operation-not-allowed') {
                            errorMessage = "Registrasi email/password tidak diaktifkan. Harap aktifkan di Firebase Console > Authentication > Sign-in method.";
                        }
                        else {
                            errorMessage = `Error: ${error.message}`; 
                        }
                        authErrorMessage.textContent = errorMessage;
                        authErrorMessage.classList.remove('hidden');
                        console.error("Register error:", error.message);
                    }
                }
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerHTML = isLoginMode ? 'Login' : 'Register';
            });

            // Google Login
            googleLoginBtn.addEventListener('click', async () => {
                authErrorMessage.classList.add('hidden'); 
                googleLoginBtn.disabled = true; 
                googleLoginBtn.innerHTML = '<div class="spinner"></div><span class="ml-2">Memuat...</span>'; 

                try {
                    await signInWithPopup(auth, googleProvider);
                    authModal.classList.add('hidden');
                    console.log("User logged in with Google successfully!");
                } catch (error) {
                    let errorMessage = "Terjadi kesalahan saat login dengan Google.";
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = "Pop-up login ditutup.";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = "Permintaan pop-up dibatalkan.";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = "Login Google tidak diaktifkan. Harap aktifkan di Firebase Console > Authentication > Sign-in method.";
                    }
                    else {
                        errorMessage = `Error: ${error.message}`;
                    }
                    authErrorMessage.textContent = errorMessage;
                    authErrorMessage.classList.remove('hidden');
                    console.error("Google login error:", error.message);
                } finally {
                    googleLoginBtn.disabled = false; 
                    googleLoginBtn.innerHTML = `<svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12.0003 4.75C14.0263 4.75 15.8453 5.483 17.2023 6.757L20.0483 3.911C18.0673 2.097 15.2303 1 12.0003 1C7.79533 1 4.10933 3.447 2.36833 7.049L5.62633 9.516C6.44633 7.054 8.94833 4.75 12.0003 4.75Z" fill="#EA4335"/>
                        <path d="M23.0003 12.0003C23.0003 11.3463 22.9463 10.6933 22.8443 10.0533H12.0003V14.3913H18.3983C18.1183 15.6173 17.3473 16.6693 16.2043 17.3883L19.4623 19.8553C21.3193 18.1073 23.0003 15.0643 23.0003 12.0003Z" fill="#4285F4"/>
                        <path d="M5.62598 14.484C5.24498 13.339 5.03198 12.17 5.03198 11.0003C5.03198 9.83033 5.24498 8.66133 5.62598 7.51633L2.36898 5.04933C1.04198 7.73433 1.04198 10.2663 2.36898 12.9513L5.62598 14.484Z" fill="#FBBC05"/>
                        <path d="M12.0003 20.25C15.2303 20.25 18.0673 19.143 20.0483 17.329L17.2023 14.483C15.8453 15.757 14.0263 16.49 12.0003 16.49C8.94833 16.49 6.44633 14.186 5.62633 11.724L2.36833 14.191C4.10933 17.793 7.79533 20.25 12.0003 20.25Z" fill="#34A853"/>
                    </svg>
                    Login dengan Google`; 
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log("User logged out.");
                } catch (error) {
                    console.error("Error logging out:", error);
                }
            });

            // --- LLM Functionality ---
            closeLlmModalBtn.addEventListener('click', () => {
                llmResponseModal.classList.add('hidden');
                llmResponseText.textContent = ''; 
            });

            async function explainHomework(description) {
                llmResponseModal.classList.remove('hidden');
                llmLoadingSpinner.classList.remove('hidden');
                llmResponseText.textContent = ''; 

                try {
                    const prompt = `Jelaskan pekerjaan rumah berikut secara singkat dan berikan beberapa tips untuk mengerjakannya: "${description}"`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmResponseText.textContent = text;
                    } else {
                        llmResponseText.textContent = "Maaf, tidak dapat menghasilkan penjelasan untuk saat ini. Coba lagi nanti.";
                        console.error("Unexpected LLM response structure:", result);
                    }
                } catch (error) {
                    llmResponseText.textContent = "Terjadi kesalahan saat menghubungi AI. Pastikan koneksi internet Anda stabil.";
                    console.error("Error calling Gemini API for explanation:", error);
                } finally {
                    llmLoadingSpinner.classList.add('hidden');
                }
            }

            async function suggestStudyPlan(description) {
                llmResponseModal.classList.remove('hidden');
                llmLoadingSpinner.classList.remove('hidden');
                llmResponseText.textContent = ''; 

                try {
                    const prompt = `Buat rencana belajar singkat untuk pekerjaan rumah ini: "${description}". Sertakan langkah-langkah, perkiraan waktu, dan fokus utama.`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmResponseText.textContent = text;
                    } else {
                        llmResponseText.textContent = "Maaf, tidak dapat menghasilkan rencana belajar untuk saat ini. Coba lagi nanti.";
                        console.error("Unexpected LLM response structure for study plan:", result);
                    }
                } catch (error) {
                    llmResponseText.textContent = "Terjadi kesalahan saat menghubungi AI untuk rencana belajar. Pastikan koneksi internet Anda stabil.";
                    console.error("Error calling Gemini API for study plan:", error);
                } finally {
                    llmLoadingSpinner.classList.add('hidden');
                }
            }

            // --- Navigation Logic ---
            function showSection(sectionId) {
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');

                // Close sidebar on mobile after navigation
                if (window.innerWidth < 768) { 
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            }

            hamburgerMenu.addEventListener('click', () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            });

            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            navJadwal.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('jadwal-section');
            });

            navPr.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('pr-section');
            });

            navHistoryPr.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('history-pr-section');
                listenForCompletedHomeworks(); // Ensure history is updated
            });

            navProfile.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('profile-section');
                updateProfileUI(); // Ensure profile UI is updated
            });

            navFindUsers.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('find-users-section');
                userSearchInput.value = ''; // Clear search input
                userSearchResults.innerHTML = ''; // Clear previous results
                noSearchResults.classList.add('hidden');
                loadingUsers.classList.add('hidden');
            });

            // --- Class Selection Modal Logic ---
            saveClassSelectionBtn.addEventListener('click', async () => {
                const selectedClass = initialClassSelect.value;
                if (selectedClass && userId) {
                    await updateRemoteUserProfile({ className: selectedClass });
                    updateScheduleDisplay(selectedClass);
                    classSelectionModal.classList.add('hidden');
                } else {
                    console.warn("No class selected or user not logged in.");
                }
            });

            // --- Profile Editing (Name, Bio, Avatar) ---
            saveProfileBtn.addEventListener('click', async () => {
                if (!userId) return;
                const newName = profileNameInput.value.trim();
                const newBio = profileBioInput.value.trim();
                
                const updates = {};
                if (newName !== currentUserProfile.name) {
                    updates.name = newName;
                }
                if (newBio !== currentUserProfile.bio) {
                    updates.bio = newBio;
                }

                if (Object.keys(updates).length > 0) {
                    await updateRemoteUserProfile(updates);
                }
            });

            editAvatarBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file && userId) {
                        try {
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const avatarUrl = event.target.result;
                                await updateRemoteUserProfile({ avatarUrl: avatarUrl });
                                console.log("Avatar uploaded!");
                            };
                            reader.readAsDataURL(file);
                        } catch (error) {
                            console.error("Error uploading avatar:", error);
                        }
                    }
                };
                input.click();
            });


            // --- Profile Photo Upload with Preview and Loading ---
            uploadProfilePhotoBtn.addEventListener('click', () => {
                photoUploadModal.classList.remove('hidden');
                photoUploadPreview.classList.add('hidden');
                photoUploadPreview.src = '';
                photoUploadInput.value = ''; // Clear selected file
                photoUploadError.classList.add('hidden');
                photoUploadBtnText.textContent = 'Unggah';
                photoUploadSpinner.classList.add('hidden');
                confirmPhotoUploadBtn.disabled = false;
            });

            cancelPhotoUploadBtn.addEventListener('click', () => {
                photoUploadModal.classList.add('hidden');
            });

            photoUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    photoUploadError.classList.add('hidden');
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        photoUploadPreview.src = event.target.result;
                        photoUploadPreview.classList.remove('hidden');
                    };
                    reader.onerror = (error) => {
                        photoUploadPreview.classList.add('hidden');
                        photoUploadError.textContent = "Gagal membaca file.";
                        photoUploadError.classList.remove('hidden');
                        console.error("Error reading file for preview:", error);
                    };
                    reader.readAsDataURL(file);
                } else {
                    photoUploadPreview.classList.add('hidden');
                }
            });

            confirmPhotoUploadBtn.addEventListener('click', async () => {
                if (!userId) {
                    photoUploadError.textContent = "Anda harus login untuk mengunggah foto.";
                    photoUploadError.classList.remove('hidden');
                    return;
                }

                const file = photoUploadInput.files[0];
                if (!file) {
                    photoUploadError.textContent = "Pilih foto untuk diunggah.";
                    photoUploadError.classList.remove('hidden');
                    return;
                }

                photoUploadBtnText.textContent = 'Mengunggah...';
                photoUploadSpinner.classList.remove('hidden');
                confirmPhotoUploadBtn.disabled = true;
                photoUploadError.classList.add('hidden');

                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const photoUrl = reader.result;
                        const photoId = Date.now().toString(); // Simple unique ID for photo
                        const newPhoto = {
                            id: photoId,
                            url: photoUrl,
                            timestamp: Date.now(),
                            likes: [],
                            comments: [],
                            userId: userId // Store the owner's userId
                        };

                        // Update user profile with new photo
                        await updateDoc(doc(db, `artifacts/${currentAppId}/users/${userId}/profile/data`), {
                            photos: arrayUnion(newPhoto)
                        });
                        console.log("Photo uploaded to profile successfully!");
                        photoUploadModal.classList.add('hidden');
                        // Re-fetch user profile to update the UI with the new photo
                        await fetchUserProfile(userId);
                    };
                    reader.onerror = (error) => {
                        throw new Error("Gagal membaca file: " + error.message);
                    };

                } catch (error) {
                    photoUploadError.textContent = `Gagal mengunggah foto: ${error.message}`;
                    photoUploadError.classList.remove('hidden');
                    console.error("Error uploading profile photo:", error);
                } finally {
                    photoUploadBtnText.textContent = 'Unggah';
                    photoUploadSpinner.classList.add('hidden');
                    confirmPhotoUploadBtn.disabled = false;
                }
            });


            // --- Photo Detail Modal (Likes & Comments) ---
            async function showPhotoDetail(photo, isCurrentUser) {
                currentViewedPhotoId = photo.id;
                currentViewedPhotoUserId = photo.userId; // Use the userId stored in the photo object
                detailPhotoImg.src = photo.url;
                await updateLikesAndCommentsUI(photo.likes, photo.comments);
                
                // Show/hide like button and comment form based on login status and ownership
                if (userId) { // If logged in
                    if (isCurrentUser) { // If it's the current user's photo
                        likeBtn.classList.add('hidden'); // Cannot like your own photo
                        commentForm.classList.remove('hidden'); // Can comment on your own photo
                    } else { // If it's another user's photo
                        likeBtn.classList.remove('hidden');
                        commentForm.classList.remove('hidden');
                        // Check if current user already liked this photo
                        if (photo.likes.includes(userId)) {
                            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3a1 1 0 01-1-1V9a1 1 0 011-1h1.586a1 1 0 00.707-.293l3.414-3.414A1 1 0 019.586 3H12a2 2 0 012 2v1h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3a1 1 0 01-1-1V9a1 1 0 011-1h1.586a1 1 0 00.707-.293l3.414-3.414A1 1 0 019.586 3H12a2 2 0 012 2v1z" /></svg><span id="like-count">${photo.likes.length}</span>`;
                            likeBtn.classList.add('text-red-500'); // Indicate liked
                        } else {
                            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3a1 1 0 01-1-1V9a1 1 0 011-1h1.586a1 1 0 00.707-.293l3.414-3.414A1 1 0 019.586 3H12a2 2 0 012 2v1h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3a1 1 0 01-1-1V9a1 1 0 011-1h1.586a1 1 0 00.707-.293l3.414-3.414A1 1 0 019.586 3H12a2 2 0 012 2v1z" /></svg><span id="like-count">${photo.likes.length}</span>`;
                            likeBtn.classList.remove('text-red-500');
                        }
                    }
                } else { // If not logged in
                    likeBtn.classList.add('hidden');
                    commentForm.classList.add('hidden');
                }

                photoDetailModal.classList.remove('hidden');
            }

            async function updateLikesAndCommentsUI(likes, comments) {
                likeCount.textContent = likes.length;
                commentCount.textContent = `${comments.length} Komentar`;
                commentsList.innerHTML = '';
                likedByUl.innerHTML = ''; // Clear previous liked by list

                if (likes.length > 0) {
                    likedByList.classList.remove('hidden');
                    // Fetch user names for likes
                    const userPromises = likes.map(uid => getDoc(doc(db, `artifacts/${currentAppId}/users/${uid}/profile/data`)));
                    const userSnaps = await Promise.all(userPromises);
                    userSnaps.forEach(snap => {
                        if (snap.exists()) {
                            const userData = snap.data();
                            const listItem = document.createElement('li');
                            listItem.textContent = userData.name || userData.email.split('@')[0];
                            likedByUl.appendChild(listItem);
                        }
                    });
                } else {
                    likedByList.classList.add('hidden');
                }

                if (comments.length === 0) {
                    noCommentsMessage.classList.remove('hidden');
                } else {
                    noCommentsMessage.classList.add('hidden');
                    // Sort comments by timestamp descending (newest first)
                    comments.sort((a, b) => b.timestamp - a.timestamp);
                    comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'bg-gray-50 dark:bg-gray-700 p-2 rounded-md';
                        commentDiv.innerHTML = `
                            <p class="font-semibold text-sm">${comment.userName || 'Pengguna Anonim'}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">${new Date(comment.timestamp).toLocaleString('id-ID')}</p>
                            <p class="text-gray-700 dark:text-gray-300">${comment.text}</p>
                        `;
                        commentsList.appendChild(commentDiv);
                    });
                }
            }

            closePhotoDetailModalBtn.addEventListener('click', () => {
                photoDetailModal.classList.add('hidden');
                currentViewedPhotoId = null;
                currentViewedPhotoUserId = null;
            });

            likeBtn.addEventListener('click', async () => {
                if (!userId || !currentViewedPhotoId || !currentViewedPhotoUserId) return;

                const userProfileDocRef = doc(db, `artifacts/${currentAppId}/users/${currentViewedPhotoUserId}/profile/data`);
                try {
                    const docSnap = await getDoc(userProfileDocRef);
                    if (docSnap.exists()) {
                        const profileData = docSnap.data();
                        const photos = profileData.photos || [];
                        const photoIndex = photos.findIndex(p => p.id === currentViewedPhotoId);

                        if (photoIndex !== -1) {
                            // Create a deep copy of the photos array to ensure immutability is handled correctly
                            // when updating nested objects in Firestore.
                            let updatedPhotos = JSON.parse(JSON.stringify(photos)); 
                            let updatedLikes = updatedPhotos[photoIndex].likes || [];
                            if (updatedLikes.includes(userId)) {
                                // Unlike
                                updatedLikes = updatedLikes.filter(id => id !== userId);
                            } else {
                                // Like
                                updatedLikes.push(userId);
                            }
                            updatedPhotos[photoIndex].likes = updatedLikes; // Update the likes array in the copy

                            // Update the entire photos array in Firestore
                            await updateDoc(userProfileDocRef, { photos: updatedPhotos });
                            await updateLikesAndCommentsUI(updatedPhotos[photoIndex].likes, updatedPhotos[photoIndex].comments); // Update UI
                            // Re-render the profile photos to update the like count on the thumbnail
                            if (currentViewedPhotoUserId === userId) {
                                await fetchUserProfile(userId); // Re-fetch current user's profile
                            } else {
                                await showOtherUserProfile(currentViewedPhotoUserId); // Re-fetch other user's profile
                            }
                            console.log(`Photo ${currentViewedPhotoId} likes updated.`);
                        }
                    }
                } catch (error) {
                    console.error("Error updating likes:", error);
                }
            });

            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId || !currentViewedPhotoId || !currentViewedPhotoUserId || !commentInput.value.trim()) return;

                const userProfileDocRef = doc(db, `artifacts/${currentAppId}/users/${currentViewedPhotoUserId}/profile/data`);
                try {
                    const docSnap = await getDoc(userProfileDocRef);
                    if (docSnap.exists()) {
                        const profileData = docSnap.data();
                        const photos = profileData.photos || [];
                        const photoIndex = photos.findIndex(p => p.id === currentViewedPhotoId);

                        if (photoIndex !== -1) {
                            // Create a deep copy
                            let updatedPhotos = JSON.parse(JSON.stringify(photos)); 
                            const newComment = {
                                userId: userId,
                                userName: currentUserProfile ? currentUserProfile.name || currentUserProfile.email.split('@')[0] : 'Anonim',
                                text: commentInput.value.trim(),
                                timestamp: Date.now()
                            };
                            // Ensure comments array exists
                            updatedPhotos[photoIndex].comments = updatedPhotos[photoIndex].comments || [];
                            updatedPhotos[photoIndex].comments.push(newComment); // Add new comment to the copy

                            // Update the entire photos array in Firestore
                            await updateDoc(userProfileDocRef, { photos: updatedPhotos });
                            await updateLikesAndCommentsUI(updatedPhotos[photoIndex].likes, updatedPhotos[photoIndex].comments); // Update UI
                            commentInput.value = ''; // Clear input
                            console.log(`Comment added to photo ${currentViewedPhotoId}.`);
                        }
                    }
                } catch (error) {
                    console.error("Error adding comment:", error);
                }
            });


            // --- Find Users Logic ---
            userSearchInput.addEventListener('input', debounce(async (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                userSearchResults.innerHTML = '';
                noSearchResults.classList.add('hidden');
                loadingUsers.classList.add('hidden');

                if (searchTerm.length < 1) { // Allow search with just 1 character
                    return;
                }

                loadingUsers.classList.remove('hidden');

                try {
                    const usersRootCollectionRef = collection(db, `artifacts/${currentAppId}/users`);
                    const userDocsSnapshot = await getDocs(usersRootCollectionRef); // Get all user ID documents

                    const allUserProfiles = [];
                    const fetchProfilePromises = [];

                    userDocsSnapshot.forEach(userDoc => {
                        const userIdFromRoot = userDoc.id;
                        if (userIdFromRoot !== userId) { // Exclude current user
                            const userProfileDocRef = doc(db, `artifacts/${currentAppId}/users/${userIdFromRoot}/profile/data`);
                            fetchProfilePromises.push(getDoc(userProfileDocRef).then(profileSnap => {
                                if (profileSnap.exists()) {
                                    return { uid: userIdFromRoot, ...profileSnap.data() };
                                }
                                return null;
                            }));
                        }
                    });

                    const fetchedProfiles = await Promise.all(fetchProfilePromises);
                    const validProfiles = fetchedProfiles.filter(p => p !== null);

                    const filteredUsers = validProfiles.filter(user => {
                        const userName = (user.name || '').toLowerCase();
                        const userEmail = (user.email || '').toLowerCase();

                        // Check if name or email includes the search term
                        return userName.includes(searchTerm) || userEmail.includes(searchTerm);
                    });

                    if (filteredUsers.length === 0) {
                        noSearchResults.classList.remove('hidden');
                    } else {
                        filteredUsers.forEach(user => {
                            const userCard = document.createElement('div');
                            userCard.className = 'p-4 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center space-x-4 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition';
                            userCard.dataset.uid = user.uid;
                            userCard.innerHTML = `
                                <img src="${user.avatarUrl || 'https://placehold.co/48x48/cccccc/333333?text=Avatar'}" alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                                <div>
                                    <p class="font-bold">${user.name || user.email.split('@')[0]}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${user.className || 'Kelas Belum Dipilih'}</p>
                                </div>
                            `;
                            userCard.addEventListener('click', () => showOtherUserProfile(user.uid));
                            userSearchResults.appendChild(userCard);
                        });
                    }
                } catch (error) {
                    console.error("Error searching users:", error);
                    userSearchResults.innerHTML = `<p class="text-red-500 text-center">Terjadi kesalahan saat mencari pengguna.</p>`;
                } finally {
                    loadingUsers.classList.add('hidden');
                }
            }, 300)); // Debounce search input

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            async function showOtherUserProfile(otherUserId) {
                if (!otherUserId) return;

                const userDocRef = doc(db, `artifacts/${currentAppId}/users/${otherUserId}/profile/data`);
                const homeworksCollectionRef = collection(db, `artifacts/${currentAppId}/users/${otherUserId}/homeworks`);
                const qActivePrs = query(homeworksCollectionRef, where("completed", "!=", true));

                try {
                    const [docSnap, prSnapshot] = await Promise.all([getDoc(userDocRef), getDocs(qActivePrs)]);

                    if (docSnap.exists()) {
                        const otherUserProfile = docSnap.data();
                        otherProfileModal.classList.remove('hidden');
                        otherProfileName.textContent = otherUserProfile.name || otherUserProfile.email.split('@')[0];
                        otherProfileEmail.textContent = otherUserProfile.email || '';
                        otherProfileClass.textContent = `Kelas: ${otherUserProfile.className || 'Belum Dipilih'}`;
                        otherProfileAvatar.src = otherUserProfile.avatarUrl || 'https://placehold.co/96x96/cccccc/333333?text=Avatar';
                        otherFollowerCount.textContent = otherUserProfile.followers ? otherUserProfile.followers.length : 0;
                        otherFollowingCount.textContent = otherUserProfile.following ? otherUserProfile.following.length : 0;

                        // Show/hide follow button
                        if (userId && userId !== otherUserId) {
                            followUnfollowBtn.classList.remove('hidden');
                            if (currentUserProfile && currentUserProfile.following && currentUserProfile.following.includes(otherUserId)) {
                                followUnfollowBtn.textContent = 'Unfollow';
                                followUnfollowBtn.classList.remove('bg-blue-500');
                                followUnfollowBtn.classList.add('bg-gray-500');
                            } else {
                                followUnfollowBtn.textContent = 'Follow';
                                followUnfollowBtn.classList.remove('bg-gray-500');
                                followUnfollowBtn.classList.add('bg-blue-500');
                            }
                            // Set dataset for the button to know who to follow/unfollow
                            followUnfollowBtn.dataset.otherUid = otherUserId;
                        } else {
                            followUnfollowBtn.classList.add('hidden');
                        }

                        // Render other user's photos
                        renderProfilePhotos(otherProfilePhotos, otherUserProfile.photos || [], false); // false for other user's photos

                        // Render other user's active PRs
                        const otherUserActivePrs = [];
                        prSnapshot.forEach(doc => {
                            otherUserActivePrs.push({ id: doc.id, ...doc.data() });
                        });
                        renderProfilePRs(otherProfilePrList, otherUserActivePrs, false);
                    } else {
                        console.error("User profile not found for UID:", otherUserId);
                        // Show a message that user profile could not be loaded
                    }
                } catch (error) {
                    console.error("Error loading other user profile:", error);
                }
            }

            closeOtherProfileModalBtn.addEventListener('click', () => {
                otherProfileModal.classList.add('hidden');
            });

            followUnfollowBtn.addEventListener('click', async (e) => {
                const otherUid = e.target.dataset.otherUid;
                if (!userId || !otherUid || userId === otherUid) return;

                const currentUserDocRef = doc(db, `artifacts/${currentAppId}/users/${userId}/profile/data`);
                const otherUserDocRef = doc(db, `artifacts/${currentAppId}/users/${otherUid}/profile/data`);

                try {
                    // Update current user's following list
                    if (followUnfollowBtn.textContent === 'Follow') {
                        await updateDoc(currentUserDocRef, {
                            following: arrayUnion(otherUid)
                        });
                        await updateDoc(otherUserDocRef, {
                            followers: arrayUnion(userId)
                        });
                        console.log(`User ${userId} followed ${otherUid}`);
                    } else {
                        await updateDoc(currentUserDocRef, {
                            following: arrayRemove(otherUid)
                        });
                        await updateDoc(otherUserDocRef, {
                            followers: arrayRemove(userId)
                        });
                        console.log(`User ${userId} unfollowed ${otherUid}`);
                    }
                    // Re-fetch current user profile to update UI
                    await fetchUserProfile(userId);
                    // Re-render other user's profile to update follower count
                    await showOtherUserProfile(otherUid);
                } catch (error) {
                    console.error("Error following/unfollowing user:", error);
                }
            });


            // Initial render of schedules and show default section
            populateClassSelects(); // Populate class selection dropdowns
            renderSchedules();
            updateDisplay(); // Call updateDisplay to set the initial day title and render schedule
            showSection('jadwal-section'); // Show Jadwal Pelajaran by default

            // Request notification permission on load
            requestNotificationPermission();

            // Set up interval for class schedule notifications (every minute)
            setInterval(checkClassScheduleForNotifications, 60 * 1000); 

            // Initial check for homework deadlines (will also run on data update)
            // checkHomeworkDeadlines() is called within listenForHomeworks()
        });
    </script>
</body>
</html>
