<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Pelajaran Kolaboratif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .day-schedule { transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; }
        .day-schedule.hidden { opacity: 0; position: absolute; top: 0; left: 0; right: 0; pointer-events: none; }
        .slide-from-right { transform: translateX(100%); }
        .slide-to-left { transform: translateX(-100%); }
        .slide-from-left { transform: translateX(-100%); }
        .slide-to-right { transform: translateX(100%); }
        .hidden-important { display: none !important; }
        .auth-form {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Auth Container (Login/Register) -->
    <div id="auth-container" class="w-full max-w-sm mx-auto">
        <!-- Login Form -->
        <div id="login-form-container" class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl auth-form">
            <h2 class="text-2xl font-bold text-center mb-2">Selamat Datang!</h2>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Silakan masuk untuk melanjutkan.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Masuk</button>
            </form>
            <p class="text-center text-sm mt-6">
                Belum punya akun? <a href="#" id="show-register-link" class="text-blue-500 hover:underline">Daftar di sini</a><br>
                atau <a href="#" id="login-guest-link" class="text-gray-500 hover:underline">Lanjutkan sebagai Tamu</a>
            </p>
        </div>

        <!-- Register Form -->
        <div id="register-form-container" class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl auth-form hidden-important">
            <h2 class="text-2xl font-bold text-center mb-6">Buat Akun Baru</h2>
            <form id="register-form">
                 <div class="mb-4">
                    <label for="register-username" class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" id="register-username" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="register-email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="register-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Daftar</button>
            </form>
            <p class="text-center text-sm mt-6">
                Sudah punya akun? <a href="#" id="show-login-link" class="text-blue-500 hover:underline">Masuk di sini</a>
            </p>
        </div>
         <p id="auth-error" class="text-red-500 text-center mt-4"></p>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="w-full max-w-md mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden flex-col" style="height: 90vh; display: none;">
        <!-- Header -->
        <header class="p-4 bg-blue-600 dark:bg-blue-700 text-white shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">Jadwal Pelajaran</h1>
                <p id="user-greeting" class="text-sm text-blue-200">Memuat...</p>
            </div>
            <div>
                <button id="admin-panel-btn" class="hidden-important bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg transition text-sm">Admin</button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg transition text-sm">Keluar</button>
            </div>
        </header>

        <!-- Schedule Section -->
        <div class="p-4 flex-shrink-0">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-day" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 id="current-day-title" class="text-xl font-semibold"></h2>
                <button id="next-day" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div id="schedule-container" class="relative overflow-hidden" style="min-height: 200px;"></div>
        </div>

        <!-- PR Section -->
        <div class="flex-grow flex flex-col p-4 border-t border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">Daftar PR</h3>
                <button id="add-pr-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                    Tambah PR
                </button>
            </div>
            <div id="pr-list" class="flex-grow overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                 <p id="no-pr-message" class="text-gray-500 dark:text-gray-400 text-center mt-8">Belum ada PR. Selamat! ðŸŽ‰</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="pr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Tambah PR Baru</h2>
            <form id="pr-form">
                <div class="mb-4">
                    <label for="pr-desc" class="block text-sm font-medium mb-1">Deskripsi PR</label>
                    <input type="text" id="pr-desc" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-pr-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Panel Admin: Buat Akun</h2>
            <form id="create-user-form">
                <div class="mb-4">
                    <label for="new-username" class="block text-sm font-medium mb-1">Username Baru</label>
                    <input type="text" id="new-username" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="new-email" class="block text-sm font-medium mb-1">Email Baru</label>
                    <input type="email" id="new-email" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="new-password" class="block text-sm font-medium mb-1">Password Awal</label>
                    <input type="text" id="new-password" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" required>
                </div>
                <p id="admin-message" class="text-sm text-center mb-4"></p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-admin-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md">Tutup</button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Buat Akun</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import fungsi-fungsi yang diperlukan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            getDoc, 
            getDocs,
            setDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            limit
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // =====================================================================================
        // PENTING: KONFIGURASI FIREBASE ANDA
        // 1. Buka https://firebase.google.com/
        // 2. Buat proyek baru.
        // 3. Di halaman proyek, klik ikon </> (Web) untuk membuat aplikasi web baru.
        // 4. Salin objek konfigurasi (firebaseConfig) dan tempel di bawah ini.
        // 5. Di menu sebelah kiri, buka Authentication -> Sign-in method -> aktifkan "Email/Password".
        // 6. Buka Firestore Database -> Create database -> Mulai dalam mode produksi (production mode).
        // 7. Di tab "Rules" Firestore, ganti aturannya menjadi:
        //    rules_version = '2';
        //    service cloud.firestore {
        //      match /databases/{database}/documents {
        //        match /{document=**} {
        //          allow read, write: if request.auth != null;
        //        }
        //      }
        //    }
        // =====================================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCU1cQlzZ6AJI7UAfMsjEmb2mTe15KG9cQ",
  authDomain: "class-schedule-f7cea.firebaseapp.com",
  projectId: "class-schedule-f7cea",
  storageBucket: "class-schedule-f7cea.firebasestorage.app",
  messagingSenderId: "192764707551",
  appId: "1:192764707551:web:051bb288069e895c4b1f6a",
  measurementId: "G-RF6ZMC9L7F"
};
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referensi Koleksi
        const usersCollection = collection(db, 'users');
        const homeworksCollection = collection(db, 'homeworks');

        // Variabel Global
        let currentUser = null;
        let currentUserData = null;
        let unsubscribeHomeworks = null;
        let unsubscribeCheckedStatus = null;

        // --- AUTHENTICATION ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');

        // Toggle form
        document.getElementById('show-register-link').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form-container').classList.add('hidden-important');
            document.getElementById('register-form-container').classList.remove('hidden-important');
        });
        document.getElementById('show-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('register-form-container').classList.add('hidden-important');
            document.getElementById('login-form-container').classList.remove('hidden-important');
        });
        document.getElementById('login-guest-link').addEventListener('click', (e) => {
            e.preventDefault();
            setupUI(null); // Setup UI untuk guest
        });

        // Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(err => authError.textContent = "Email atau password salah.");
        });

        // Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            try {
                // Cek apakah ada user lain, jika tidak, user pertama jadi admin
                const q = query(usersCollection, limit(1));
                const existingUsers = await getDocs(q);
                const role = existingUsers.empty ? 'admin' : 'member';

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    username: username,
                    email: email,
                    role: role
                });
            } catch (err) {
                authError.textContent = "Gagal membuat akun. Mungkin email sudah digunakan.";
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeHomeworks) unsubscribeHomeworks();
            if (unsubscribeCheckedStatus) unsubscribeCheckedStatus();
            
            currentUser = user;
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                currentUserData = userDoc.exists() ? { id: user.uid, ...userDoc.data() } : null;
                setupUI(currentUserData);
            } else {
                currentUserData = null;
                // UI untuk guest sudah dihandle oleh link "Lanjutkan sebagai Tamu"
                // Jika user logout, tampilkan halaman login
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
            }
        });

        // --- UI SETUP ---
        function setupUI(user) {
            if (user || user === null) { // null berarti guest
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                
                const userGreeting = document.getElementById('user-greeting');
                const addPrBtn = document.getElementById('add-pr-btn');
                const adminPanelBtn = document.getElementById('admin-panel-btn');
                const logoutBtn = document.getElementById('logout-btn');

                if (user) { // Member atau Admin
                    userGreeting.textContent = `Hai, ${user.username}! (${user.role})`;
                    addPrBtn.classList.remove('hidden-important');
                    logoutBtn.classList.remove('hidden-important');
                    if (user.role === 'admin') {
                        adminPanelBtn.classList.remove('hidden-important');
                    } else {
                        adminPanelBtn.classList.add('hidden-important');
                    }
                } else { // Guest
                    userGreeting.textContent = 'Anda masuk sebagai Tamu';
                    addPrBtn.classList.add('hidden-important');
                    adminPanelBtn.classList.add('hidden-important');
                    logoutBtn.classList.add('hidden-important'); // Sembunyikan tombol logout untuk guest
                }
                
                initializeSchedule();
                listenForHomeworks();

            } else {
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
            }
        }

        // --- SCHEDULE LOGIC (Sama seperti sebelumnya) ---
        const scheduleData = [
            { day: 'Senin', subjects: [{ time: '07:45-09:15', name: 'Kimia', color: 'bg-red-200 dark:bg-red-800' }, { time: '09:15-11:45', name: 'MatTL', color: 'bg-blue-200 dark:bg-blue-800' }, { time: '11:45-13:15', name: 'PK', color: 'bg-green-200 dark:bg-green-800' }, { time: '13:55-15:15', name: 'SB', color: 'bg-yellow-200 dark:bg-yellow-800' }] },
            { day: 'Selasa', subjects: [{ time: '07:45-09:15', name: 'Fis', color: 'bg-indigo-200 dark:bg-indigo-800' }, { time: '09:15-11:00', name: 'Bio', color: 'bg-teal-200 dark:bg-teal-800' }, { time: '11:00-12:30', name: 'Big', color: 'bg-pink-200 dark:bg-pink-800' }, { time: '13:15-14:35', name: 'MatTL', color: 'bg-blue-200 dark:bg-blue-800' }] },
            { day: 'Rabu', subjects: [{ time: '07:45-09:15', name: 'Bio', color: 'bg-teal-200 dark:bg-teal-800' }, { time: '09:
